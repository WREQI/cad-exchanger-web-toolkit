// ****************************************************************************
//
// Copyright (C) 2008-2014, Roman Lygin. All rights reserved.
// Copyright (C) 2014-2021, CADEX. All rights reserved.
//
// This file is part of the CAD Exchanger software.
//
// This file may be used under the terms and conditions of the License
// Agreement supplied with the software.
//
// This file is provided "AS IS" WITH NO WARRANTY OF ANY KIND, EITHER EXPRESSED
// OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE WARRANTY OF DESIGN,
// MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
//
// ****************************************************************************
(function(g,f){"object"===typeof exports&&"undefined"!==typeof module?f(exports,require("three")):"function"===typeof define&&define.amd?define(["exports","three"],f):(g=g||self,f(g.cadex=g.cadex||{},THREE));}(this,function(cadex,THREE){
var g="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var m=l(this),n;
if("function"==typeof Object.setPrototypeOf)n=Object.setPrototypeOf;else{var q;a:{var r={a:!0},t={};try{t.__proto__=r;q=t.a;break a}catch(a){}q=!1}n=q?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var u=n;
function v(a,b){a.prototype=g(b.prototype);a.prototype.constructor=a;if(u)u(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var f=Object.getOwnPropertyDescriptor(b,c);f&&Object.defineProperty(a,c,f)}else a[c]=b[c];a.u=b.prototype}function w(a,b){b.setRGB(a.r,a.g,a.b)}function x(a,b){w(a,b.color);b.opacity=a.a;1>a.a&&(b.transparent=!0)}function y(a){var b=cadex.ModelData_RepresentationVisitor.call(this)||this;b.h=void 0;b.i=a;return b}v(y,cadex.ModelData_RepresentationVisitor);
y.prototype.visitBRepRepresentation=function(a){var b=this;return a.bodyList().then(function(c){0<c.size()&&(b.h=new THREE.Group,a.name&&(b.h.name=a.name));for(var f=0,h=c.size();f<h;f++)c.element(f).prs.data().forEach(function(k){(k=b.i(k))&&b.h.add(k)})})};y.prototype.visitPolyRepresentation=function(a){var b=this;return a.polyShapeList().then(function(c){0<c.size()&&(b.h=new THREE.Group,a.name&&(b.h.name=a.name));for(var f=0,h=c.size();f<h;f++){var k=c.element(f);(k=b.i(k))&&b.h.add(k)}})};
y.prototype.visitPolyRepresentation=y.prototype.visitPolyRepresentation;y.prototype.visitBRepRepresentation=y.prototype.visitBRepRepresentation;function z(a,b){var c=cadex.ModelData_SceneGraphElementVisitor.call(this)||this;c.i=[a];c.h=[b.defaultAppearance||new cadex.ModelData_Appearance];c.s=new Map;c.o=b;return c}v(z,cadex.ModelData_SceneGraphElementVisitor);
z.prototype.visitPart=function(a){var b=this,c=this.h[this.h.length-1];a.appearance&&(c=c.clone().combineWith(a.appearance));a=a.representation(this.o.representationSelector);if(!a)return Promise.resolve();var f=new y(function(h){return B(h,c)});return a.accept(f).then(function(){f.h&&b.i[b.i.length-1].add(f.h)})};
z.prototype.visitInstanceEnter=function(a){var b=new THREE.Object3D,c=(new THREE.Matrix4).fromArray(a.transformation.elements);b.applyMatrix(c);this.i[this.i.length-1].add(b);this.i.push(b);(a=a.appearance)&&this.h.push(this.h[this.h.length-1].clone().combineWith(a));return!0};z.prototype.visitInstanceLeave=function(a){this.i.pop();a.appearance&&this.h.pop()};z.prototype.visitAssemblyEnter=function(){return!0};z.prototype.visitAssemblyLeave=function(){};z.prototype.visitAssemblyLeave=z.prototype.visitAssemblyLeave;
z.prototype.visitAssemblyEnter=z.prototype.visitAssemblyEnter;z.prototype.visitInstanceLeave=z.prototype.visitInstanceLeave;z.prototype.visitInstanceEnter=z.prototype.visitInstanceEnter;z.prototype.visitPart=z.prototype.visitPart;
function C(a){if(a&&a.coords&&a.coords.length){var b=new THREE.BufferGeometry;b.addAttribute("position",new THREE.BufferAttribute(a.coords,3));a.colors&&b.addAttribute("color",new THREE.BufferAttribute(a.colors,3));a instanceof cadex.ModelData_IndexedTriangleSet&&(a.indexes&&b.setIndex(new THREE.BufferAttribute(a.indexes,1)),a.normals?b.addAttribute("normal",new THREE.BufferAttribute(a.normals,3)):b.computeVertexNormals(),a.uvCoordinates&&b.addAttribute("uv",new THREE.BufferAttribute(a.uvCoordinates,
2)));a instanceof cadex.ModelData_IndexedPolyLineSet&&a.indexes&&b.setIndex(new THREE.BufferAttribute(a.indexes,1));return b}}
function B(a,b){var c=C(a);if(c){var f=a.appearances,h=a.appearanceRanges;f&&h||(f=[a.appearance],h=void 0);f=f.map(function(d){if(d){var e=new cadex.ModelData_Appearance;e.combineWith(b);e.combineWith(d);d=e}else d=b;return d});var k=function(d){var e;1<f.length&&h&&1<h.length?e=f.map(function(F,p){var A=0===p?0:h[p-1];c.addGroup(A,h[p]-A,p);return d(F)}):e=d(f[0]||b);return e};if(a instanceof cadex.ModelData_IndexedTriangleSet)return a=k(function(d){var e=new THREE.MeshPhongMaterial;d&&(d.material?
(d=d.material,x(d.diffuseColor,e),w(d.specularColor,e.specular),e.specular.r/=10,e.specular.g/=10,e.specular.b/=10,w(d.emissiveColor,e.emissive),e.shininess=d.shininess):d.genericColor&&x(d.genericColor,e));return e}),new THREE.Mesh(c,a);if(a instanceof cadex.ModelData_PolyLineSet)return a=k(function(){var d=new THREE.LineBasicMaterial;b&&(b.material&&b.material.diffuseColor?x(b.material.diffuseColor,d):b.genericColor&&x(b.genericColor,d));return d}),new THREE.LineSegments(c,a);if(a instanceof cadex.ModelData_PolyPointSet)return a=
k(function(){var d=new THREE.PointsMaterial;var e=b&&(b.material&&b.material.diffuseColor||b.genericColor);e&&x(e,d);return d}),new THREE.Points(c,a)}}function D(a,b){var c=new THREE.Group;b=new z(c,b);return a.accept(b).then(function(){if(1<c.children.length)return c;if(1===c.children.length)return c.children[0]})}function E(a,b){var c=new THREE.Group;b=new z(c,b);return a.accept(b).then(function(){return c})}
function G(){this.i=new cadex.ModelData_RepresentationMaskSelector(cadex.ModelData_RepresentationMask.ModelData_RM_Any);this.h=new cadex.ModelData_Appearance(new cadex.ModelData_ColorObject(.5,.5,.5))}
m.Object.defineProperties(G.prototype,{representationSelector:{configurable:!0,enumerable:!0,get:function(){return this.i},set:function(a){a instanceof cadex.ModelData_RepresentationSelector&&(this.i=a)}},defaultAppearance:{configurable:!0,enumerable:!0,get:function(){return this.h},set:function(a){a instanceof cadex.ModelData_Appearance?this.h=a:this.h.set(a)}}});function H(a){this.h=a instanceof G?a:new G}
H.prototype.j=function(a){return a instanceof cadex.ModelData_Model?THREE&&THREE.Object3D?E(a,this.h):Promise.reject(Error("THREE namespace is not defined. Please link three.js library (https://threejs.org) before to use converter.")):Promise.reject(Error("TypeError: invalid argument (it should be instance of cadex.ModelData_Model)"))};
H.prototype.m=function(a){return a instanceof cadex.ModelData_SceneGraphElement?THREE&&THREE.Object3D?D(a,this.h):Promise.reject(Error("THREE namespace is not defined. Please link three.js library (https://threejs.org) before to use converter.")):Promise.reject(Error("TypeError: invalid argument (it should be instance of cadex.ModelData_SceneGraphElement)"))};
H.prototype.l=function(a){if(!(a instanceof cadex.ModelData_PolyVertexSet))throw Error("TypeError: invalid argument (it should be instance of cadex.ModelData_PolyVertexSet)");if(!THREE||!THREE.Object3D)throw Error("THREE namespace is not defined. Please link three.js library (https://threejs.org) before to use converter.");return B(a,this.h.defaultAppearance)};m.Object.defineProperties(H.prototype,{parameters:{configurable:!0,enumerable:!0,get:function(){return this.h}}});
H.prototype.convertPolyVertexSet=H.prototype.l;H.prototype.convertSceneGraphElement=H.prototype.m;H.prototype.convertModel=H.prototype.j;Object.assign(cadex,{ModelAlgo_ThreejsConverter:H,ModelAlgo_ThreejsConverterParameters:G});
}));
